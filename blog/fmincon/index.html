

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    
      <title>CasADi - Blog - Breaking free of CasADi&#39;s solvers</title>
    

    
    <link href="https://web.casadi.org/_css/font-awesome.min.css" rel="stylesheet">

    
    <link href="https://web.casadi.org/_css/bootstrap.min.css" rel="stylesheet">

    
    <link href="https://web.casadi.org/_css/pygments-default.css" rel="stylesheet">

    
    <link href="https://web.casadi.org/_css/casadi-theme.min.css" rel="stylesheet">

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ['\\(','\\)'] ],
          displayMath: [ ['$$','$$'], ['\\[','\\]'] ],
          processEnvironments: false
        }
      });
    </script>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  </head>

  <body>



<nav class="navbar fixed-top navbar-expand-lg nav-top">
  <div class="container">
    <a class="navbar-brand" href="https://web.casadi.org/"></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fa fa-bars" aria-hidden="true"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
      <ul class="navbar-nav">
        
        
          
          <li class="nav-item active">
          
            <a class="nav-link" href="/">Home</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/get/">Try/Install</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/docs/">Docs</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/support/">Support</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/source/">Source</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/publications/">Publications</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/events/">Workshops</a>
          </li>
        
          
          <li class="nav-item active">
          
            <a class="nav-link" href="/blog/">Blog</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

<div id="main" class="container">
  <div class="row">
    <div class="col">
      <h1>Breaking free of CasADi&#39;s solvers</h1>
      <span class="reading-time text-muted">Estimated reading time: 3 minutes</span>

      <p>Once you&rsquo;ve modeled your optimization problem in CasADi,
you don&rsquo;t have to stick to the solvers we interface.</p>
<p>In this post, we briefly demonstrate how we can make CasADi and Matlab&rsquo;s <code>fmincon</code> cooperate.</p>
<h1 id="trivial-unconstrained-problem">Trivial unconstrained problem</h1>
<p>Let&rsquo;s consider a very simple scalar unconstrained optimization:</p>
<p>$$
\begin{align}
\displaystyle \underset{x}
{\text{minimize}}\quad &amp; \sin(x)^2 \
\end{align}
$$</p>
<p>You can solve this with <code>fminunc</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="n">fminunc</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span> <span class="nb">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>^<span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</span></span></code></pre></div><p>The first argument, an anonymous function, can contain any code, including CasADi code.</p>
<p>Let&rsquo;s use CasADi to evaluate the objective:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="n">import</span> <span class="n">casadi</span><span class="o">.*</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="p">=</span> <span class="n">MX</span><span class="p">.</span><span class="n">sym</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="p">=</span> <span class="n">Function</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">,{</span><span class="n">x</span><span class="p">},{</span><span class="nb">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>^<span class="mi">2</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fminunc</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span> <span class="n">full</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="mf">0.1</span><span class="p">)</span>
</span></span></code></pre></div><p>Simple enough, but do mind the <code>full</code> to go from CasADi numeric matrix type to a Matlab matrix.</p>
<p>As is, <code>fminunc</code> will perform finite differences under the hood.
That&rsquo;s a shame since CasADi can do algorithmic differentiation.</p>
<p>Let&rsquo;s supply the gradient of the objective, computed by CasADi, as well:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="n">fg</span> <span class="p">=</span> <span class="n">Function</span><span class="p">(</span><span class="s">&#39;fg&#39;</span><span class="p">,{</span><span class="n">x</span><span class="p">},{</span><span class="n">y</span><span class="p">,</span><span class="n">gradient</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl"><span class="n">fg_full</span> <span class="p">=</span> <span class="n">returntypes</span><span class="p">(</span><span class="s">&#39;full&#39;</span><span class="p">,</span><span class="n">fg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">options</span> <span class="p">=</span> <span class="n">optimoptions</span><span class="p">(</span><span class="s">&#39;fminunc&#39;</span><span class="p">,</span><span class="s">&#39;SpecifyObjectiveGradient&#39;</span><span class="p">,</span><span class="n">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">fminunc</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span> <span class="n">fg_full</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span></code></pre></div><p>Note the <code>returntypes</code> helper such that you don&rsquo;t need to explicitly convert from a CasADi numeric matrix to a Matlab matrix.</p>
<p>For this scalar example, you will hardly see any speed-up.
For a decision space of size $n$, the default finite differences approach will cost you <code>n</code> times the cost of the objective function evaluation:
<code>O(n cost(f))</code>
The algorithmic differentation approach will just cost you <code>O(cost(f))</code>. There&rsquo;s a screencast available to learn <a href="https://www.youtube.com/watch?v=mYOkLkS5yqc">more about this aspect</a>.</p>
<p>Download code: <a href="demo1.m">demo1.m</a></p>
<h1 id="optimal-control-problem">Optimal control problem</h1>
<p>Next, we will consider the <a href="https://web.casadi.org/blog/ocp/#coding">the race car example</a>.</p>
<p>We assume we have modeled the problem as NLP:
$$
\begin{align}
\displaystyle \underset{x}
{\text{minimize}}\quad &amp; f(x,p) \newline
\text{subject to} \, \quad &amp; \textrm{lbg} \leq g(x,p) \leq \textrm{ubg} \newline
\end{align}
$$</p>
<p>We will solve this problem using <code>fmincon</code>.
We just need to construct CasADi functions to compute the objective and constraints and their sensitivities,
and massage them to match the API of <code>fmincon</code>.
Again, you can omit the sensitivities and rely on (much slower!) finite differences.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">% Function to compute objective and its gradient
</span></span><span class="line"><span class="cl">f = casadi.Function(&#39;f&#39;,{x,p},{f,gradient(f,x)});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">% Function to compute constraint vector, its Jacobian, and bounds
</span></span><span class="line"><span class="cl">g = casadi.Function(&#39;g&#39;,{x,p},{g,jacobian(g,x),lbg,ubg});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">options = optimoptions(&#39;fmincon&#39;,...
</span></span><span class="line"><span class="cl">                       &#39;Display&#39;,&#39;iter&#39;,...
</span></span><span class="line"><span class="cl">                       &#39;Algorithm&#39;,&#39;sqp&#39;,...
</span></span><span class="line"><span class="cl">                       &#39;SpecifyObjectiveGradient&#39;,true,...
</span></span><span class="line"><span class="cl">                       &#39;SpecifyConstraintGradient&#39;,true);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[x_opt,fval] = fmincon(@(x) obj_casadi(f,x,p),x0,[],[],[],[],[],[], @(x) nonlin_casadi(g,x,p),options);
</span></span></code></pre></div><p>Note the helper functions <code>obj_casadi</code> and <code>nonlin_casadi</code>.</p>
<p>The first helper is simple enough, and could also be achieved with <code>returntypes</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="k">function</span><span class="w"> </span>[f,g]<span class="p">=</span><span class="nf">obj_casadi</span><span class="p">(</span>f_function,x,p<span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">]</span> <span class="p">=</span> <span class="n">f_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">f</span> <span class="p">=</span> <span class="n">full</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">g</span> <span class="p">=</span> <span class="n">full</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>The second helper is somewhat more involved since we need to separate out the equalities from the inequalities:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="k">function</span><span class="w"> </span>[c,ceq,gradc,gradceq]<span class="p">=</span><span class="nf">nonlin_casadi</span><span class="p">(</span>g_function,x,p<span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">% Morph the constraints into c&lt;=0, ceq==0</span>
</span></span><span class="line"><span class="cl">  <span class="c">%</span>
</span></span><span class="line"><span class="cl">  <span class="c">% CasADi way: lbg &lt;= g &lt;= ubg</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">g</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">lbg</span><span class="p">,</span><span class="n">ubg</span><span class="p">]</span> <span class="p">=</span> <span class="n">g_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">g</span> <span class="p">=</span> <span class="n">full</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">lbg</span> <span class="p">=</span> <span class="n">full</span><span class="p">(</span><span class="n">lbg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">ubg</span> <span class="p">=</span> <span class="n">full</span><span class="p">(</span><span class="n">ubg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">J</span> <span class="p">=</span> <span class="n">sparse</span><span class="p">(</span><span class="n">J</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c">% Classify into eq/ineq</span>
</span></span><span class="line"><span class="cl">  <span class="n">eq</span> <span class="p">=</span> <span class="n">lbg</span><span class="o">==</span><span class="n">ubg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ineq</span> <span class="p">=</span> <span class="n">lbg</span><span class="o">~=</span><span class="n">ubg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c">% Classify into free/fixed</span>
</span></span><span class="line"><span class="cl">  <span class="n">lbg_fixed</span> <span class="p">=</span> <span class="n">lbg</span><span class="o">~=-</span><span class="nb">inf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ubg_fixed</span> <span class="p">=</span> <span class="n">ubg</span><span class="o">~=</span><span class="nb">inf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c">% Constraint vector</span>
</span></span><span class="line"><span class="cl">  <span class="n">c</span> <span class="p">=</span> <span class="p">[</span><span class="n">lbg</span><span class="p">(</span><span class="n">ineq</span><span class="o">&amp;</span><span class="n">lbg_fixed</span><span class="p">)</span><span class="o">-</span><span class="n">g</span><span class="p">(</span><span class="n">ineq</span><span class="o">&amp;</span><span class="n">lbg_fixed</span><span class="p">);</span><span class="n">g</span><span class="p">(</span><span class="n">ineq</span><span class="o">&amp;</span><span class="n">ubg_fixed</span><span class="p">)</span><span class="o">-</span><span class="n">ubg</span><span class="p">(</span><span class="n">ineq</span><span class="o">&amp;</span><span class="n">ubg_fixed</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">  <span class="n">ceq</span> <span class="p">=</span> <span class="n">g</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span><span class="o">-</span><span class="n">lbg</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c">% Constraint Jacobian tranposed</span>
</span></span><span class="line"><span class="cl">  <span class="n">gradc</span> <span class="p">=</span> <span class="p">[</span><span class="o">-</span><span class="n">J</span><span class="p">(</span><span class="n">ineq</span><span class="o">&amp;</span><span class="n">lbg_fixed</span><span class="p">,:);</span><span class="n">J</span><span class="p">(</span><span class="n">ineq</span><span class="o">&amp;</span><span class="n">ubg_fixed</span><span class="p">,:)]</span><span class="o">&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">gradceq</span> <span class="p">=</span> <span class="n">J</span><span class="p">(</span><span class="n">eq</span><span class="p">,:)</span><span class="o">&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>There&rsquo;s more options to go from here with <code>fmincon</code>.
You may use <code>which_depends</code> to classify constraints into linear/nonlinear, you may specify a Hessian,
or you can work with matrix-free (large-scale) methods that require the computation of a matrix-vector product instead of the matrix.</p>
<p>And remember, you always have the code-generation option to speed up your problem if the bottleneck lies with the function evaluations.</p>
<p>In conclusion, choosing to model a problem in CasADi does not lock you in with our solvers.
We&rsquo;ve seen how you can embed calls to CasADi function evaluations into third-party codes.</p>
<p>Download code: <a href="demo.m">demo.m</a>, <a href="nonlin_casadi.m">nonlin_casadi.m</a>, <a href="obj_casadi.m">obj_casadi.m</a>,</p>

    </div>
  </div>
</div>
    


<a href="http://ocp2023.casadi.org" target="_blank" id="bottom-banner" class="visible">


  <div class="container p-3">
    <div class="row justify-content-md-center">
      <div class="col-md-auto text-center">
        <p>ðŸ“£Next CasADi training: Nov. 20-22</p>

      </div>
    </div>
  </div>
</a>


    
    <footer>
      <div class="container">
        <div class="row justify-content-md-center">
          <div class="col-md-auto text-center">
            <ul id="social" class="list-inline">
              
                <li class="list-inline-item">
                  <a href="https://github.com/casadi/casadi" title="github">
                    <i class="fa fa-github"></i>
                  </a>
                </li>
              
                <li class="list-inline-item">
                  <a href="https://twitter.com/casadi_software" title="twitter">
                    <i class="fa fa-twitter"></i>
                  </a>
                </li>
              
                <li class="list-inline-item">
                  <a href="https://www.youtube.com/channel/UC3VDpv5Pi3R-a2VkcJN1RLw" title="youtube">
                    <i class="fa fa-youtube"></i>
                  </a>
                </li>
              
            </ul>
            <p class="copyright">Copyright 2023.</p>
          </div>
        </div>
      </div>
    </footer>

    
    <script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    
    <script src="https://web.casadi.org/_js/bootstrap.min.js"></script>

    
    <script src="https://web.casadi.org/_js/scripts.js"></script>

    
    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_CHTML">
</script>

    
  </body>

</html>

