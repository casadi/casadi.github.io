

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    
      <title>CasADi - Blog - CasADi-driven MPC in Simulink (part 1)</title>
    

    
    <link href="https://web.casadi.org/_css/font-awesome.min.css" rel="stylesheet">

    
    <link href="https://web.casadi.org/_css/bootstrap.min.css" rel="stylesheet">

    
    <link href="https://web.casadi.org/_css/pygments-default.css" rel="stylesheet">

    
    <link href="https://web.casadi.org/_css/casadi-theme.min.css" rel="stylesheet">

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ['\\(','\\)'] ],
          displayMath: [ ['$$','$$'], ['\\[','\\]'] ],
          processEnvironments: false
        }
      });
    </script>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  </head>

  <body>



<nav class="navbar fixed-top navbar-expand-lg nav-top">
  <div class="container">
    <a class="navbar-brand" href="https://web.casadi.org/"></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fa fa-bars" aria-hidden="true"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
      <ul class="navbar-nav">
        
        
          
          <li class="nav-item active">
          
            <a class="nav-link" href="/">Home</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/get/">Try/Install</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/docs/">Docs</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/support/">Support</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/source/">Source</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/publications/">Publications</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/events/">Workshops</a>
          </li>
        
          
          <li class="nav-item active">
          
            <a class="nav-link" href="/blog/">Blog</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

<div id="main" class="container">
  <div class="row">
    <div class="col">
      <h1>CasADi-driven MPC in Simulink (part 1)</h1>
      <span class="reading-time text-muted">Estimated reading time: 4 minutes</span>

      <p>CasADi is not a monolithic tool. We can easily couple it to other software to have more fun.
Today we&rsquo;ll be exploring a <em>simple</em> coupling with Simulink. We&rsquo;ll be showing off nonlinear MPC (NMPC).</p>
<figure class=" default">
  <a href="https://web.casadi.org/blog/mpc-simulink/simulink_block.png" target="_blank">
  <img src="https://web.casadi.org/blog/mpc-simulink/simulink_block.png"  />
  </a>
  <figcaption>
    <h1>Simulink block diagram</h1>
  </figcaption>
</figure>
<h1 id="the-details">The details</h1>
<p>For plant model, we&rsquo;ll be using the familiar <a href="https://en.wikipedia.org/wiki/Van_der_Pol_oscillator">Van der Pol oscillator</a> ode:</p>
<p>$$
\frac{d\begin{bmatrix}x_1\\ x_2\end{bmatrix}}{dt} = \begin{bmatrix}(1-x_2^2)\, x_1-x_2+u\\ x_1\end{bmatrix}.
$$</p>
<p>In the above Simulink block diagram, the <code>rhs</code> MATLAB function block encodes this ode:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="k">function</span><span class="w"> </span>y <span class="p">=</span><span class="w"> </span><span class="nf">rhs</span><span class="p">(</span>x,u<span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">y</span> <span class="p">=</span> <span class="p">[(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>^<span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">u</span><span class="p">;</span> <span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>The <code>casadi_block</code> computes the discrete control signal by solving an Optimal Control Problem (OCP).
The act of closing the loop with the continuous plant makes our setup effectively an MPC controller.</p>
<p>The OCP problem here simply drives the states to zero:</p>
<p>$$
\begin{align}
\underset{\begin{array}{c}x(\cdot), u(\cdot)\end{array}}
{\text{minimize}}\quad &amp; \int_{0}^{T}{ \left( x_1(t)^2 + x_2(t)^2 + u(t)^2 \right) \, dt} \newline
\text{subject to} \, \quad
&amp; \left\{\begin{array}{l}
\dot{x}_1(t) = (1-x_2(t)^2) \, x_1(t) - x_2(t) + u(t) \newline
\dot{x}_2(t) = x_1(t) \newline
-1.0 \le u(t) \le 1.0, \quad x_1(t) \ge -0.25
\end{array}\right.
\quad  t \in [0,T] \newline
&amp; x_1(0)=\bar{x}_1, \quad x_2(0)=\bar{x}_2
\end{align}
$$</p>
<p>We will use the <a href="https://github.com/casadi/casadi/blob/3.1.0/docs/examples/matlab/direct_multiple_shooting.m">multiple shooting transcription from the CasADi examples</a> to cast the OCP to an NLP problem. In short, the multiple shooting code reads like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="n">w</span> <span class="p">=</span> <span class="p">{};</span> <span class="c">% decision variables</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span> <span class="p">=</span> <span class="p">{};</span> <span class="c">% cosntraints</span>
</span></span><span class="line"><span class="cl"><span class="n">J</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c">% objective</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">% Initial conditions</span>
</span></span><span class="line"><span class="cl"><span class="n">X0</span> <span class="p">=</span> <span class="n">MX</span><span class="p">.</span><span class="n">sym</span><span class="p">(</span><span class="s">&#39;X0&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">% Formulate the NLP</span>
</span></span><span class="line"><span class="cl"><span class="n">Xk</span> <span class="p">=</span> <span class="n">X0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">k</span><span class="p">=</span><span class="mi">0</span><span class="p">:</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="c">% New NLP variable for the control</span>
</span></span><span class="line"><span class="cl">    <span class="n">Uk</span> <span class="p">=</span> <span class="n">MX</span><span class="p">.</span><span class="n">sym</span><span class="p">(</span><span class="s">&#39;U&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">w</span> <span class="p">=</span> <span class="p">{</span><span class="n">w</span><span class="p">{:},</span> <span class="n">Uk</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">% Integrate till the end of the interval</span>
</span></span><span class="line"><span class="cl">    <span class="n">Fk</span> <span class="p">=</span> <span class="n">F</span><span class="p">(</span><span class="s">&#39;x0&#39;</span><span class="p">,</span> <span class="n">Xk</span><span class="p">,</span> <span class="s">&#39;p&#39;</span><span class="p">,</span> <span class="n">Uk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Xk_end</span> <span class="p">=</span> <span class="n">Fk</span><span class="p">.</span><span class="n">xf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">J</span><span class="p">=</span><span class="n">J</span><span class="o">+</span><span class="n">Fk</span><span class="p">.</span><span class="n">qf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">% New NLP variable for state at end of interval</span>
</span></span><span class="line"><span class="cl">    <span class="n">Xk</span> <span class="p">=</span> <span class="n">MX</span><span class="p">.</span><span class="n">sym</span><span class="p">(</span><span class="s">&#39;X&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">w</span> <span class="p">=</span> <span class="p">{</span><span class="n">w</span><span class="p">{:},</span> <span class="n">Xk</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">% Add equality constraint</span>
</span></span><span class="line"><span class="cl">    <span class="n">g</span> <span class="p">=</span> <span class="p">{</span><span class="n">g</span><span class="p">{:},</span> <span class="n">Xk_end</span><span class="o">-</span><span class="n">Xk</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">% Create an NLP solver</span>
</span></span><span class="line"><span class="cl"><span class="n">prob</span> <span class="p">=</span> <span class="n">struct</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">vertcat</span><span class="p">(</span><span class="n">w</span><span class="p">{:}),</span> <span class="s">&#39;g&#39;</span><span class="p">,</span> <span class="n">vertcat</span><span class="p">(</span><span class="n">g</span><span class="p">{:}));</span>
</span></span><span class="line"><span class="cl"><span class="n">solver</span> <span class="p">=</span> <span class="n">nlpsol</span><span class="p">(</span><span class="s">&#39;solver&#39;</span><span class="p">,</span> <span class="s">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">prob</span><span class="p">);</span>
</span></span></code></pre></div><p>Recall from that example the solution plot:</p>
<figure class=" default">
  <a href="https://web.casadi.org/blog/mpc-simulink/reference.png" target="_blank">
  <img src="https://web.casadi.org/blog/mpc-simulink/reference.png"  />
  </a>
  <figcaption>
    <h1>Reference solution from multiple shooting example</h1>
  </figcaption>
</figure>
<p>As we all know, CasADi makes an important distinction between <em>initialisation</em> and <em>evaluation</em> steps.
We would not want to construct an NLP afresh at every sampling time!
Rather, we&rsquo;d like to construct the NLP once, and simply evaluate it repeatedly using slightly different numerical inputs.
For this purpose, we chose a <code>MATLAB System</code> block in Simulink.</p>
<p>In abbreviated form, the code in that block reads:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="k">classdef</span> <span class="n">casadi_block</span> <span class="o">&lt;</span> <span class="n">matlab</span><span class="p">.</span><span class="n">System</span>
</span></span><span class="line"><span class="cl">    <span class="k">properties</span> <span class="p">(</span><span class="n">Access</span> <span class="p">=</span> <span class="n">private</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">casadi_solver</span>
</span></span><span class="line"><span class="cl">        <span class="n">lbx</span>
</span></span><span class="line"><span class="cl">        <span class="n">ubx</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">    <span class="k">methods</span> <span class="p">(</span><span class="n">Access</span> <span class="p">=</span> <span class="n">protected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">        function</span><span class="w"> </span><span class="nf">setupImpl</span><span class="p">(</span>obj,~,~<span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">obj</span><span class="p">.</span><span class="n">casadi_solver</span> <span class="p">=</span> <span class="n">nlpsol</span><span class="p">(</span><span class="s">&#39;solver&#39;</span><span class="p">,</span> <span class="s">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">obj</span><span class="p">.</span><span class="n">lbx</span> <span class="p">=</span> <span class="n">lbw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">obj</span><span class="p">.</span><span class="n">ubx</span> <span class="p">=</span> <span class="n">ubw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">        function</span><span class="w"> </span>u <span class="p">=</span><span class="w"> </span><span class="nf">stepImpl</span><span class="p">(</span>obj,x,t<span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">lbw</span> <span class="p">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">lbx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">ubw</span> <span class="p">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">ubx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">solver</span> <span class="p">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">casadi_solver</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">lbw</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="p">=</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">ubw</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="p">=</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">sol</span> <span class="p">=</span> <span class="n">solver</span><span class="p">(</span><span class="s">&#39;x0&#39;</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="s">&#39;lbx&#39;</span><span class="p">,</span> <span class="n">lbw</span><span class="p">,</span> <span class="s">&#39;ubx&#39;</span><span class="p">,</span> <span class="n">ubw</span><span class="p">,</span><span class="c">...</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#39;lbg&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">.</span><span class="n">lbg</span><span class="p">,</span> <span class="s">&#39;ubg&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">.</span><span class="n">ubg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">u</span> <span class="p">=</span> <span class="n">full</span><span class="p">(</span><span class="n">sol</span><span class="p">.</span><span class="n">x</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>As you can see, <code>setupImpl</code> takes care of constructing the NLP, and <code>stepImpl</code> solves the actual NLP while constraining $x_1(0)$ and $x_2(0)$ to the state <em>measurement</em> coming in from Simulink.</p>
<p>In general, you may distinguish several approaches to bring CasADi computations into simulink:</p>
<ol>
<li>write CasADi-Matlab code, and use an <code>interpreted Matlab code</code> in Simulink</li>
<li>write CasADi-Matlab code, and use CasADi&rsquo;s codegenerator to spit out a pure c function (or mex file). Then, interface that pure c function in simulink</li>
<li>write a mex file from scratch using CasADi-C++ code</li>
</ol>
<p>We used option 1 here. It&rsquo;s the most simple way. Obviously this is not the most efficient way,
but since all of CasADi&rsquo;s number-crunching happens in compiled libraries, <code>interpreted Matlab code</code> is not as bad as it sounds perhaps.
Anyway, make sure that you indicate to Simulink that the code is <code>interpreted</code>:</p>
<figure class=" default">
  <a href="https://web.casadi.org/blog/mpc-simulink/interpreted.png" target="_blank">
  <img src="https://web.casadi.org/blog/mpc-simulink/interpreted.png"  />
  </a>
  <figcaption>
    <h1>Simulink block diagram</h1>
  </figcaption>
</figure>
<p>Let&rsquo;s jump to results.</p>
<h1 id="the-results">The results</h1>
<p>MPC control signal:</p>
<figure class=" default">
  <a href="https://web.casadi.org/blog/mpc-simulink/simulink_control.png" target="_blank">
  <img src="https://web.casadi.org/blog/mpc-simulink/simulink_control.png"  />
  </a>
  <figcaption>
    <h1>MPC control signal</h1>
  </figcaption>
</figure>
<p>State evolution:</p>
<figure class=" default">
  <a href="https://web.casadi.org/blog/mpc-simulink/simulink_state.png" target="_blank">
  <img src="https://web.casadi.org/blog/mpc-simulink/simulink_state.png"  />
  </a>
  <figcaption>
    <h1>State evolution</h1>
  </figcaption>
</figure>
<p>Note how the control trajectory (up to t=10s) matches the reference solution further up in this post.
The state trajectory matches too, but Simulink shows you more detail: you see the smooth time-evolution of the system in-between the sampling times.
Pretty neat, huh?
Just for fun, I dropped in some noised at around t=10s. The MPC controller manages to recover from this.</p>
<p>This post showed a quick way to drop your CasADi code into Simulink.
We&rsquo;re curious what you&rsquo;ll cook up based on this example. Enjoy!</p>
<p>Downloads: <a href="casadi_block.m">casadi_block.m</a>, <a href="mpc_demo.slx">mpc_demo.slx</a></p>
    </div>
  </div>
</div>
    


<a href="http://ocp2023.casadi.org" target="_blank" id="bottom-banner" class="visible">


  <div class="container p-3">
    <div class="row justify-content-md-center">
      <div class="col-md-auto text-center">
        <p>ðŸ“£Next CasADi training: Nov. 20-22</p>

      </div>
    </div>
  </div>
</a>


    
    <footer>
      <div class="container">
        <div class="row justify-content-md-center">
          <div class="col-md-auto text-center">
            <ul id="social" class="list-inline">
              
                <li class="list-inline-item">
                  <a href="https://github.com/casadi/casadi" title="github">
                    <i class="fa fa-github"></i>
                  </a>
                </li>
              
                <li class="list-inline-item">
                  <a href="https://twitter.com/casadi_software" title="twitter">
                    <i class="fa fa-twitter"></i>
                  </a>
                </li>
              
                <li class="list-inline-item">
                  <a href="https://www.youtube.com/channel/UC3VDpv5Pi3R-a2VkcJN1RLw" title="youtube">
                    <i class="fa fa-youtube"></i>
                  </a>
                </li>
              
            </ul>
            <p class="copyright">Copyright 2023.</p>
          </div>
        </div>
      </div>
    </footer>

    
    <script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    
    <script src="https://web.casadi.org/_js/bootstrap.min.js"></script>

    
    <script src="https://web.casadi.org/_js/scripts.js"></script>

    
    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_CHTML">
</script>

    
  </body>

</html>

