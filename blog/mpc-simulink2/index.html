

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    
      <title>CasADi - Blog - CasADi-driven MPC in Simulink (part 2)</title>
    

    
    <link href="https://web.casadi.org/_css/font-awesome.min.css" rel="stylesheet">

    
    <link href="https://web.casadi.org/_css/bootstrap.min.css" rel="stylesheet">

    
    <link href="https://web.casadi.org/_css/pygments-default.css" rel="stylesheet">

    
    <link href="https://web.casadi.org/_css/casadi-theme.min.css" rel="stylesheet">

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ['\\(','\\)'] ],
          displayMath: [ ['$$','$$'], ['\\[','\\]'] ],
          processEnvironments: false
        }
      });
    </script>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  </head>

  <body>



<nav class="navbar fixed-top navbar-expand-lg nav-top">
  <div class="container">
    <a class="navbar-brand" href="https://web.casadi.org/"></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fa fa-bars" aria-hidden="true"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
      <ul class="navbar-nav">
        
        
          
          <li class="nav-item active">
          
            <a class="nav-link" href="/">Home</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/get/">Try/Install</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/docs/">Docs</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/support/">Support</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/source/">Source</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/publications/">Publications</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/events/">Workshops</a>
          </li>
        
          
          <li class="nav-item active">
          
            <a class="nav-link" href="/blog/">Blog</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

<div id="main" class="container">
  <div class="row">
    <div class="col">
      <h1>CasADi-driven MPC in Simulink (part 2)</h1>
      <span class="reading-time text-muted">Estimated reading time: 3 minutes</span>

      <p>In this post, we have a new take on nonlinear MPC in Simulink using CasADi.</p>
<h1 id="interpreter-mode">Interpreter mode</h1>
<p>In an <a href="https://web.casadi.org/blog/mpc-simulink/">earlier post on MPC in Simulink</a>, we used an interpreted &lsquo;Matlab system&rsquo; block in the simulink diagram. This is flexible, but slow because of interpreter overhead.</p>
<h1 id="code-generation-mode">code-generation mode</h1>
<p>In an <a href="https://web.casadi.org/blog/s-function/">earlier post on S-Functions</a>, we showed how Casadi-generated C code can be embedded efficiently in a Simulink diagram using S-functions.
The result is fast, but has restrictions: only <code>SqpMethod</code> combined with <code>Qrqp</code> or <code>Osqp</code> solver can be code-generated (as of 3.5), not e.g. <code>ipopt</code>.</p>
<h1 id="c-api-mode">C api mode</h1>
<p>Here, we will work with CasADi&rsquo;s C API (new since 3.5) and make Ipopt run within Simulink.</p>
<h2 id="constructing-a-function">Constructing a Function</h2>
<p>After constructing an Ipopt solver, we create a $\mathbb{R}^2$ symbol to represent current state, and call the solver with symbolic lower and upper variable bounds:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">solver = nlpsol(&#39;solver&#39;, &#39;ipopt&#39;, prob, options);

s0 = MX.sym(&#39;s0&#39;,2);

lbw_sym = MX(lbw);
ubw_sym = MX(ubw);
lbw_sym(1:2) = s0;
ubw_sym(1:2) = s0;

sol_sym = solver(&#39;x0&#39;, w0, &#39;lbx&#39;, lbw_sym, &#39;ubx&#39;, ubw_sym,...
            &#39;lbg&#39;, lbg, &#39;ubg&#39;, ubg);
</code></pre></div><p>The resultant expression graph, which has the NLP solver embedded, is used to create a Function mapping from current state to optimal control action to be applied:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="n">f</span> <span class="p">=</span> <span class="n">Function</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">,{</span><span class="n">s0</span><span class="p">},{</span><span class="n">sol_sym</span><span class="p">.</span><span class="n">x</span><span class="p">(</span><span class="mi">3</span><span class="p">)});</span>
</code></pre></div><p>Next, we save the Function to the disk. It should be noted that the steps up to here could as well be done from Python, or using different modeling techniques (e.g. Opti).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="n">f</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;f.casadi&#39;</span><span class="p">);</span>
</code></pre></div><h2 id="c-api">C API</h2>
<p>Classic CasADi codegen gives you an API with C functions for querying dimensions of inputs and outputs and evaluating. Those C functions are prefixed with the CasADi Function name:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cp">#include</span> <span class="cpf">&#34;f.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">int_T</span> <span class="n">n_in</span>  <span class="o">=</span> <span class="n">f_n_in</span><span class="p">();</span>
<span class="n">int_T</span> <span class="n">n_out</span> <span class="o">=</span> <span class="n">f_n_out</span><span class="p">();</span>
<span class="n">int_T</span> <span class="n">sz_arg</span><span class="p">,</span> <span class="n">sz_res</span><span class="p">,</span> <span class="n">sz_iw</span><span class="p">,</span> <span class="n">sz_w</span><span class="p">;</span>
<span class="n">f_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sz_arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz_res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz_iw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz_w</span><span class="p">);</span>

<span class="n">f</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">iw</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</code></pre></div><p>The C API mirrors this syntax, but uses an identifier argument instead of prefixing:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cp">#include</span> <span class="cpf">&lt;casadi/casadi_c.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">int_T</span> <span class="n">n_in</span> <span class="o">=</span> <span class="n">casadi_c_n_in_id</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="n">int_T</span> <span class="n">n_out</span> <span class="o">=</span> <span class="n">casadi_c_n_out_id</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="n">casadi_c_work_id</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz_arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz_res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz_iw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz_w</span><span class="p">);</span>
</code></pre></div><p>This identifier is obtained from loading the saved file from disk, and specifying a particular Function by name:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">int ret = casadi_c_push_file(&#34;f.casadi&#34;);
int id = casadi_c_id(&#34;f&#34;);
</code></pre></div><p>Calling the function involves checking out and releasing thread-local memory:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">int mem = casadi_c_checkout_id(id);
casadi_c_eval_id(id, arg, res, iw, w, mem);
casadi_c_release_id(id, mem);
</code></pre></div><h2 id="compilation">Compilation</h2>
<p>Different from code-generation, our S-function is still dependent on the CasADi runtime.</p>
<p>We&rsquo;ll need to compile the S-function using appropriate include and link flags:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">lib_path = GlobalOptions.getCasadiPath();
inc_path = GlobalOptions.getCasadiIncludePath();
mex(&#39;-v&#39;,[&#39;-I&#39; inc_path],[&#39;-L&#39; lib_path],&#39;-lcasadi&#39;, &#39;casadi_fun.c&#39;)
</code></pre></div><h1 id="conclusion">Conclusion</h1>
<p>With the above ingredients, one can embed arbitrary CasADi Functions into Simulink with minimal overhead. A fully functional example is available: <a href="do_demo.m">do_demo.m</a> (run this file first), <a href="casadi_fun.c">casadi_fun.c</a>, <a href="mpc_demo.slx">mpc_demo.slx</a></p>

    </div>
  </div>
</div>
    <footer>
      <div class="container">
        <div class="row justify-content-md-center">
          <div class="col-md-auto text-center">
            <ul id="social" class="list-inline">
              
                <li class="list-inline-item">
                  <a href="https://github.com/casadi/casadi" title="github">
                    <i class="fa fa-github"></i>
                  </a>
                </li>
              
                <li class="list-inline-item">
                  <a href="https://twitter.com/casadi_software" title="twitter">
                    <i class="fa fa-twitter"></i>
                  </a>
                </li>
              
                <li class="list-inline-item">
                  <a href="https://www.youtube.com/channel/UC3VDpv5Pi3R-a2VkcJN1RLw" title="youtube">
                    <i class="fa fa-youtube"></i>
                  </a>
                </li>
              
            </ul>
            <p class="copyright">Copyright 2023.</p>
          </div>
        </div>
      </div>
    </footer>

    
    <script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    
    <script src="https://web.casadi.org/_js/bootstrap.min.js"></script>

    
    <script src="https://web.casadi.org/_js/scripts.js"></script>

    
    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_CHTML">
</script>

    
  </body>

</html>

