

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    
      <title>CasADi - Blog - CasADi codegen and S-Functions</title>
    

    
    <link href="https://web.casadi.org/_css/font-awesome.min.css" rel="stylesheet">

    
    <link href="https://web.casadi.org/_css/bootstrap.min.css" rel="stylesheet">

    
    <link href="https://web.casadi.org/_css/pygments-default.css" rel="stylesheet">

    
    <link href="https://web.casadi.org/_css/casadi-theme.min.css" rel="stylesheet">

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ['\\(','\\)'] ],
          displayMath: [ ['$$','$$'], ['\\[','\\]'] ],
          processEnvironments: false
        }
      });
    </script>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  </head>

  <body>



<nav class="navbar fixed-top navbar-expand-lg nav-top">
  <div class="container">
    <a class="navbar-brand" href="https://web.casadi.org/"></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fa fa-bars" aria-hidden="true"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
      <ul class="navbar-nav">
        
        
          
          <li class="nav-item active">
          
            <a class="nav-link" href="/">Home</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/get/">Try/Install</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/docs/">Docs</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/support/">Support</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/source/">Source</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/publications/">Publications</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/events/">Workshops</a>
          </li>
        
          
          <li class="nav-item active">
          
            <a class="nav-link" href="/blog/">Blog</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

<div id="main" class="container">
  <div class="row">
    <div class="col">
      <h1>CasADi codegen and S-Functions</h1>
      <span class="reading-time text-muted">Estimated reading time: 3 minutes</span>

      <p>While the <a href="http://docs.casadi.org">user guide</a> does explain code-generation in full detail,
it is handy to have a demonstration in a real environment like Matlab&rsquo;s S-functions.</p>
<h1 id="the-problem">The problem</h1>
<p>We will design a Simulink block that implements a nonlinear mapping from ($\mathbf{R}^2$, $\mathbf{R}$) to ($\mathbf{R}$,$\mathbf{R}^2$):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="n">import</span> <span class="n">casadi</span><span class="o">.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="p">=</span> <span class="n">MX</span><span class="p">.</span><span class="n">sym</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="p">=</span> <span class="n">MX</span><span class="p">.</span><span class="n">sym</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">w</span> <span class="p">=</span> <span class="nb">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">*</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">z</span> <span class="p">=</span> <span class="nb">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="n">y</span><span class="o">+</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="p">=</span> <span class="n">Function</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">,{</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">},{</span><span class="n">w</span><span class="p">,</span><span class="n">z</span><span class="p">});</span>
</span></span></code></pre></div><h1 id="code-generating">Code-generating</h1>
<p>You may generate code from this with:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="n">f</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="s">&#39;f.c&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>However, we&rsquo;ll use the more advanced syntax since we have advanced requirements.
In particular, we will use Matlab&rsquo;s data-types for real and integer numbers, requiring us to include a header:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="n">cg_options</span> <span class="p">=</span> <span class="n">struct</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">cg_options</span><span class="p">.</span><span class="n">casadi_real</span> <span class="p">=</span> <span class="s">&#39;real_T&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">cg_options</span><span class="p">.</span><span class="n">casadi_int</span> <span class="p">=</span> <span class="s">&#39;int_T&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">cg_options</span><span class="p">.</span><span class="n">with_header</span> <span class="p">=</span> <span class="n">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">cg</span> <span class="p">=</span> <span class="n">CodeGenerator</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">,</span><span class="n">cg_options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">cg</span><span class="p">.</span><span class="n">add_include</span><span class="p">(</span><span class="s">&#39;simstruc.h&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">cg</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">cg</span><span class="p">.</span><span class="n">generate</span><span class="p">();</span>
</span></span></code></pre></div><p>This will create <code>f.c</code>, and also <code>f.h</code> (since we set the option <code>with_header</code>).</p>
<h1 id="s-function-initialize-routine">S-Function initialize routine</h1>
<p>Our S-Function code should include the header <code>f.h</code>.
With it, we have access to the problem dimensions:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="n">int_T</span> <span class="n">n_in</span>  <span class="p">=</span> <span class="n">f_n_in</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">int_T</span> <span class="n">n_out</span> <span class="p">=</span> <span class="n">f_n_out</span><span class="p">();</span>
</span></span></code></pre></div><p>Next, we can set the block&rsquo;s input/output port dimensions:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="n">int_T</span> <span class="nb">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span>!<span class="n">ssSetNumInputPorts</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">n_in</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="nb">i</span><span class="p">=</span><span class="mi">0</span><span class="p">;</span><span class="nb">i</span><span class="o">&lt;</span><span class="n">n_in</span><span class="p">;</span><span class="o">++</span><span class="nb">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">const</span> <span class="n">int_T</span><span class="o">*</span> <span class="n">sp</span> <span class="p">=</span> <span class="n">f_sparsity_in</span><span class="p">(</span><span class="nb">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">Dense</span> <span class="n">vector</span> <span class="n">inputs</span> <span class="n">assumed</span> <span class="n">here</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">ssSetInputPortWidth</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="nb">i</span><span class="p">,</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">ssSetInputPortDirectFeedThrough</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="nb">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span>!<span class="n">ssSetNumOutputPorts</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">n_out</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="nb">i</span><span class="p">=</span><span class="mi">0</span><span class="p">;</span><span class="nb">i</span><span class="o">&lt;</span><span class="n">n_out</span><span class="p">;</span><span class="o">++</span><span class="nb">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">const</span> <span class="n">int_T</span><span class="o">*</span> <span class="n">sp</span> <span class="p">=</span> <span class="n">f_sparsity_out</span><span class="p">(</span><span class="nb">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">Dense</span> <span class="n">vector</span> <span class="n">outputs</span> <span class="n">assumed</span> <span class="n">here</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">ssSetOutputPortWidth</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="nb">i</span><span class="p">,</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>CaADi codegenerated functions require working memory to evaluate.
We can query the size requirements with:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="n">int_T</span> <span class="n">sz_arg</span><span class="p">,</span> <span class="n">sz_res</span><span class="p">,</span> <span class="n">sz_iw</span><span class="p">,</span> <span class="n">sz_w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">f_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sz_arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz_res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz_iw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz_w</span><span class="p">);</span>
</span></span></code></pre></div><p>Our notion of workspaces maps easily to Simulink&rsquo;s:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="n">ssSetNumRWork</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">sz_w</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">ssSetNumIWork</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">sz_iw</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">ssSetNumPWork</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">sz_arg</span><span class="o">+</span><span class="n">sz_res</span><span class="p">);</span>
</span></span></code></pre></div><p>The only issue is that we differentiate between pointers for the arguments and the results,
while they are combined into a generic <code>void*</code> buffer in Simulink.</p>
<h1 id="s-function-output-routine">S-Function output routine</h1>
<p>First, we need access to the working memory. Simple enough for the real and integer workspaces:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl">    <span class="n">real_T</span><span class="o">*</span> <span class="n">w</span> <span class="p">=</span> <span class="n">ssGetRWork</span><span class="p">(</span><span class="n">S</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">int_T</span><span class="o">*</span> <span class="n">iw</span> <span class="p">=</span> <span class="n">ssGetIWork</span><span class="p">(</span><span class="n">S</span><span class="p">);</span>
</span></span></code></pre></div><p>For <code>arg</code> and <code>res</code> we have to perform arithmatic and casting from <code>void**</code> to the desired types:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl">    <span class="n">void</span><span class="o">**</span> <span class="n">p</span> <span class="p">=</span> <span class="n">ssGetPWork</span><span class="p">(</span><span class="n">S</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">const</span> <span class="n">real_T</span><span class="o">**</span> <span class="n">arg</span> <span class="p">=</span> <span class="p">(</span><span class="n">const</span> <span class="n">real_T</span><span class="o">**</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">+</span><span class="p">=</span> <span class="n">sz_arg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">real_T</span><span class="o">**</span> <span class="n">res</span> <span class="p">=</span> <span class="p">(</span><span class="n">real_T</span><span class="o">**</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
</span></span></code></pre></div><p>Next, make <code>arg</code> point to the input data:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="nb">i</span><span class="p">=</span><span class="mi">0</span><span class="p">;</span> <span class="nb">i</span><span class="o">&lt;</span><span class="n">n_in</span><span class="p">;</span><span class="o">++</span><span class="nb">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">arg</span><span class="p">[</span><span class="nb">i</span><span class="p">]</span> <span class="p">=</span> <span class="o">*</span><span class="n">ssGetInputPortRealSignalPtrs</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="nb">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><p>Make <code>res</code> point to the output data:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="nb">i</span><span class="p">=</span><span class="mi">0</span><span class="p">;</span> <span class="nb">i</span><span class="o">&lt;</span><span class="n">n_out</span><span class="p">;</span><span class="o">++</span><span class="nb">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">res</span><span class="p">[</span><span class="nb">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">ssGetOutputPortRealSignal</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="nb">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><p>Finally, run the CasADi function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl">    <span class="n">f</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">iw</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span></code></pre></div><h1 id="running">Running</h1>
<p>To actually run the block, we need to compile our S-Function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="n">mex</span> <span class="n">s_function</span><span class="p">.</span><span class="n">c</span> <span class="n">f</span><span class="p">.</span><span class="n">c</span>
</span></span></code></pre></div><figure class=" default">
  <a href="https://web.casadi.org/blog/s-function/simulink.png" target="_blank">
  <img src="https://web.casadi.org/blog/s-function/simulink.png"  />
  </a>
  <figcaption>
    <h1>View of simulink diagram with our S-Function block in it</h1>
  </figcaption>
</figure>
<figure class=" default">
  <a href="https://web.casadi.org/blog/s-function/scope.png" target="_blank">
  <img src="https://web.casadi.org/blog/s-function/scope.png"  />
  </a>
  <figcaption>
    <h1>Numeric simulation result</h1>
  </figcaption>
</figure>
<p>Download code: <a href="do_demo.m">do_demo.m</a>, <a href="s_function.c">s_function.c</a>, <a href="demo.slx">demo.slx</a>.</p>
<p>In summary, we&rsquo;ve shown how to use CasADi codegen in general, and in the setting of Simulink S-Functions specifically.</p>

    </div>
  </div>
</div>
    
    
    <footer>
      <div class="container">
        <div class="row justify-content-md-center">
          <div class="col-md-auto text-center">
            <ul id="social" class="list-inline">
              
                <li class="list-inline-item">
                  <a href="https://github.com/casadi/casadi" title="github">
                    <i class="fa fa-github"></i>
                  </a>
                </li>
              
                <li class="list-inline-item">
                  <a href="https://twitter.com/casadi_software" title="twitter">
                    <i class="fa fa-twitter"></i>
                  </a>
                </li>
              
                <li class="list-inline-item">
                  <a href="https://www.youtube.com/channel/UC3VDpv5Pi3R-a2VkcJN1RLw" title="youtube">
                    <i class="fa fa-youtube"></i>
                  </a>
                </li>
              
            </ul>
            <p class="copyright">Copyright 2023.</p>
          </div>
        </div>
      </div>
    </footer>

    
    <script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    
    <script src="https://web.casadi.org/_js/bootstrap.min.js"></script>

    
    <script src="https://web.casadi.org/_js/scripts.js"></script>

    
    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_CHTML">
</script>

    
  </body>

</html>

